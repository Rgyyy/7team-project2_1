{"version":3,"sources":["turbopack:///[project]/src/actions/userLogout.ts","turbopack:///[project]/src/lib/prisma.ts","turbopack:///[project]/src/app/login/page.tsx/__nextjs-internal-proxy.mjs","turbopack:///[project]/.next-internal/server/app/login/page/actions.js (server actions loader)","turbopack:///[project]/src/actions/userLogin.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { cookies } from \"next/headers\";\r\n\r\nexport async function logoutUser() {\r\n  try {\r\n    // 쿠키에서 토큰 제거\r\n    const cookieStore = await cookies();\r\n    cookieStore.delete(\"token\");\r\n\r\n    console.log(\"로그아웃 성공\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"로그아웃 에러:\", error);\r\n    return { success: false, error: \"로그아웃 중 오류가 발생했습니다.\" };\r\n  }\r\n}\r\n","\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ||\r\n  new PrismaClient({\r\n    log: ['query', 'error', 'warn'],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/login/page.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/login/page.tsx\",\n    \"default\",\n);\n","export {logoutUser as '00b7a57c14b2684975b2c912dfa8f62e85d5d7f389'} from 'ACTIONS_MODULE0'\nexport {loginUser as '6061d53a51fcdc6bdce578a9776d8bfbde70a413a1'} from 'ACTIONS_MODULE1'\n","\"use server\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport bcrypt from \"bcryptjs\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport { cookies, headers } from \"next/headers\";\r\nimport { redirect } from \"next/navigation\";\r\n\r\nexport async function loginUser(prevState: any, formData: FormData) {\r\n  try {\r\n    const userId = formData.get(\"userId\") as string;\r\n    const userPassword = formData.get(\"userPassword\") as string;\r\n    const gpsLocation = formData.get(\"gpsLocation\") as string;\r\n    const deviceInfo = formData.get(\"deviceInfo\") as string;\r\n\r\n    if (!userId || !userPassword) {\r\n      return { error: \"아이디와 비밀번호를 모두 입력해주세요.\" };\r\n      // 폼단에서 처리 되어야하는데 이게 뜬다면 뭔가 문제가 있는것.\r\n    }\r\n    const user = await prisma.user_data.findUnique({\r\n      where: { user_id: userId },\r\n    });\r\n    if (!user) {\r\n      return { error: \"존재하지 않는 사용자입니다.\" };\r\n    }\r\n\r\n    // 회원 상태 확인 (0: 정상, 1: 탈퇴)\r\n    if (user.user_state === \"1\") {\r\n      return { error: \"탈퇴한 회원입니다.\" };\r\n    }\r\n\r\n    const isPasswordValid = await bcrypt.compare(\r\n      userPassword,\r\n      user.user_password\r\n    );\r\n    if (!isPasswordValid) {\r\n      return { error: \"비밀번호가 일치하지 않습니다.\" };\r\n    }\r\n\r\n    const token = jwt.sign(\r\n      {\r\n        userId: user.user_id,\r\n      },\r\n      process.env.JWT_SECRET!,\r\n      { expiresIn: \"24h\" }\r\n    );\r\n    const cookieStore = await cookies();\r\n    cookieStore.set(\"token\", token, {\r\n      httpOnly: true,\r\n      secure: false, // ✅ HTTP에서도 작동하도록 false로 설정 (HTTPS 사용 시 true로 변경)\r\n      sameSite: \"lax\", // ✅ strict → lax 로 변경\r\n      path: \"/\", // ✅ 전체 경로에서 쿠키 접근\r\n      maxAge: 60 * 60 * 24, // 24시간\r\n    });\r\n\r\n    // 로그인 기록 저장, 추후 저장할 요소 추가제거 고려해봐야할듯.\r\n    const headersList = await headers();\r\n    let ip =\r\n      headersList.get(\"x-forwarded-for\") ||\r\n      headersList.get(\"x-real-ip\") ||\r\n      headersList.get(\"x-client-ip\") ||\r\n      headersList.get(\"cf-connecting-ip\") || // Cloudflare\r\n      headersList.get(\"remote-addr\") ||\r\n      \"unknown\";\r\n    // x-forwarded-for에 여러 IP가 있는 경우 첫 번째 IP 사용\r\n    if (ip.includes(\",\")) {\r\n      ip = ip.split(\",\")[0].trim();\r\n    }\r\n    if (ip === \"::1\" || ip === \"127.0.0.1\") {\r\n      ip = \"localhost\";\r\n    }\r\n    const serverUserAgent = headersList.get(\"user-agent\") || \"unknown\";\r\n\r\n    // 클라이언트에서 전송된 정보와 서버에서 수집한 정보 결합\r\n    const finalLocation = gpsLocation || null;\r\n    const finalPlatform = deviceInfo || serverUserAgent;\r\n\r\n    await prisma.login_record.create({\r\n      data: {\r\n        user_id: user.user_id,\r\n        login_time: new Date(),\r\n        login_location: finalLocation,\r\n        login_ip: ip,\r\n        login_platform: finalPlatform,\r\n      },\r\n    });\r\n\r\n    return { success: true };\r\n  } catch (error: any) {\r\n    console.error(\"로그인 에러:\", error);\r\n    return { error: \"로그인 중 오류가 발생했습니다.\" };\r\n  }\r\n}\r\n"],"names":[],"mappings":"oQAEA,EAAA,EAAA,CAAA,CAAA,MAEO,eAAe,IACpB,GAAI,CAMF,MAHA,CADoB,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,GAAA,EACrB,MAAM,CAAC,SAEnB,QAAQ,GAAG,CAAC,WACL,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,WAAY,GACnB,CAAE,SAAS,EAAO,MAAO,oBAAqB,CACvD,CACF,0CAZsB,IAAA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,8TCHtB,IAAA,EAAA,EAAA,CAAA,CAAA,OAIO,IAAM,EAFP,AAGJ,EAHI,CAAA,CAGY,MAAM,EACtB,IAAI,EAAA,YAAY,CAAC,CACf,IAAK,CAAC,QAAS,QAAS,OAAO,AACjC,wDCPa,CAAA,EADf,AACe,EADf,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,wRAA0R,EACvT,uDACA,gEAHW,CAAA,EADf,AACe,EADf,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,oQAAsQ,EACnS,mCACA,0OCLJ,IAAA,EAAA,EAAA,CAAA,CAAA,oBCEA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,MAGO,eAAe,EAAU,CAAc,CAAE,CAAkB,EAChE,GAAI,CACF,IAAM,EAAS,EAAS,GAAG,CAAC,UACtB,EAAe,EAAS,GAAG,CAAC,gBAC5B,EAAc,EAAS,GAAG,CAAC,eAC3B,EAAa,EAAS,GAAG,CAAC,cAEhC,GAAI,CAAC,GAAU,CAAC,EACd,MAAO,CAAE,KADmB,CACZ,uBAAwB,EAG1C,IAAM,EAAO,MAAM,EAAA,MAAM,CAAC,SAAS,CAAC,UAAU,CAAC,CAC7C,MAAO,CAAE,QAAS,CAAO,CAC3B,GACA,GAAI,CAAC,EACH,IADS,EACF,CAAE,MAAO,iBAAkB,EAIpC,GAAI,AAAoB,KAAK,GAApB,UAAU,CACjB,MAAO,CAAE,MAAO,YAAa,EAO/B,GAAI,CAJoB,AAInB,MAJyB,EAAA,OAAM,CAAC,CAIf,MAJsB,CAC1C,EACA,EAAK,aAAa,EAGlB,MAAO,CAAE,MAAO,kBAAmB,EAGrC,IAAM,EAAQ,EAAA,OAAG,CAAC,IAAI,CACpB,CACE,OAAQ,EAAK,OAAO,AACtB,EACA,QAAQ,GAAG,CAAC,UAAU,CACtB,CAAE,UAAW,KAAM,GAGrB,AADoB,OAAM,CAAA,EAAA,EAAA,OAAA,AAAO,GAAA,EACrB,GAAG,CAAC,QAAS,EAAO,CAC9B,UAAU,EACV,QAAQ,EACR,SAAU,MACV,KAAM,IACN,OAAQ,KAAK,AACf,GAGA,EAJoB,EAId,EAAc,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,IAC7B,EACF,EAAY,GAAG,CAAC,oBAChB,EAAY,GAAG,CAAC,cAChB,EAAY,GAAG,CAAC,gBAChB,EAAY,GAAG,CAAC,qBAChB,EADuC,AAC3B,GAAG,CAAC,SADoC,OAEpD,UAEE,EAAG,QAAQ,CAAC,MAAM,AACpB,GAAK,EAAG,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,EAAA,GAEjB,QAAP,GAAuB,cAAP,CAAO,GAAa,CACtC,EAAK,WAAA,EAEP,IAAM,EAAkB,EAAY,GAAG,CAAC,eAAiB,UAgBzD,OAVA,MAAM,EAAA,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC,CAC/B,KAAM,CACJ,QAAS,EAAK,OAAO,CACrB,WAAY,IAAI,KAChB,eAPkB,CAOF,EAPiB,KAQjC,SAAU,EACV,eARkB,CAQF,EARgB,CASlC,CACF,GAEO,CAAE,QAAS,EAAK,CACzB,CAAE,MAAO,EAAY,CAEnB,OADA,QAAQ,KAAK,CAAC,UAAW,GAClB,CAAE,MAAO,mBAAoB,CACtC,CACF,0CApFsB,IAAA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA","ignoreList":[2]}